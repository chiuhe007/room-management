<!-- pages/my-bookings/my-bookings.wxml -->
<view class="container">
  
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view wx:if="{{!isLoggedIn}}" class="login-panel">
    <view class="login-card">
      <view class="login-icon">ğŸ‘¤</view>
      <view class="login-title">æŸ¥çœ‹æˆ‘çš„é¢„è®¢</view>
      <view class="login-desc">ç™»å½•åå¯ä»¥æŸ¥çœ‹æ‚¨çš„é¢„è®¢è®°å½•å’Œäº«å—æ›´å¤šä¸ªæ€§åŒ–æœåŠ¡</view>
      
      <button class="login-btn" bindtap="loginWithWechat">
        <text class="login-icon-text">ï¿½</text>
        å¾®ä¿¡æˆæƒç™»å½•
      </button>
      
      <view class="guest-options">
        <view class="guest-text">è¿˜æ²¡æœ‰é¢„è®¢è®°å½•ï¼Ÿ</view>
        <button class="guest-btn" bindtap="goToRooms">
          <text class="guest-btn-text">ç«‹å³é¢„è®¢æˆ¿é—´</text>
        </button>
      </view>
      
      <view class="login-tips">
        <view class="tip-item">âœ“ æŸ¥çœ‹é¢„è®¢çŠ¶æ€å’Œè¯¦æƒ…</view>
        <view class="tip-item">âœ“ æ¥æ”¶é¢„è®¢ç¡®è®¤é€šçŸ¥</view>
        <view class="tip-item">âœ“ äº«å—ä¼šå‘˜ä¸“å±ä¼˜æƒ </view>
      </view>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view wx:if="{{isLoggedIn}}">
    
    <!-- å·¥å…·æ  -->
    <view class="toolbar">
      <view class="toolbar-left">
        <text class="page-title">æˆ‘çš„é¢„è®¢</text>
        <text wx:if="{{hiddenBookingIds.length > 0}}" class="hidden-count">
          (å·²éšè—{{hiddenBookingIds.length}}æ¡)
        </text>
      </view>
      <view class="toolbar-right">
        <button wx:if="{{hiddenBookingIds.length > 0}}" 
                class="manage-btn" 
                bindtap="showHiddenManager">
          ç®¡ç†éšè—
        </button>
      </view>
    </view>
    
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <text>{{refreshing ? 'åˆ·æ–°ä¸­...' : 'åŠ è½½ä¸­...'}}</text>
  </view>

    <!-- é¢„è®¢åˆ—è¡¨ -->
    <view class="bookings-container">
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{!pendingBookings.length && !confirmedBookings.length && !completedBookings.length && !cancelledBookings.length}}" class="empty">
        <view class="empty-icon">ğŸ“‹</view>
        <view class="empty-text">æš‚æ— é¢„è®¢è®°å½•</view>
        <button class="book-now-btn" bindtap="goToRooms">ç«‹å³é¢„è®¢</button>
      </view>

      <!-- å¾…ç¡®è®¤é¢„è®¢ -->
      <view wx:if="{{pendingBookings.length > 0}}" class="section">
        <view class="section-title">
          <view class="title-icon">â³</view>
          <text class="title-text">å¾…ç¡®è®¤ ({{pendingBookings.length}})</text>
        </view>
        <view wx:for="{{pendingBookings}}" wx:key="id" class="booking-card pending">
          <template is="booking-item" data="{{item}}"/>
        </view>
      </view>

      <!-- å·²ç¡®è®¤é¢„è®¢ï¼ˆé¢„è®¢æˆåŠŸï¼‰ -->
      <view wx:if="{{confirmedBookings.length > 0}}" class="section">
        <view class="section-title">
          <view class="title-icon">âœ…</view>
          <text class="title-text">é¢„è®¢æˆåŠŸ ({{confirmedBookings.length}})</text>
        </view>
        <view wx:for="{{confirmedBookings}}" wx:key="id" class="booking-card confirmed">
          <template is="booking-item" data="{{item}}"/>
        </view>
      </view>

      <!-- å·²å®Œæˆé¢„è®¢ -->
      <view wx:if="{{completedBookings.length > 0}}" class="section">
        <view class="section-title">
          <view class="title-icon">ğŸ†</view>
          <text class="title-text">å·²å®Œæˆ ({{completedBookings.length}})</text>
        </view>
        <view wx:for="{{completedBookings}}" wx:key="id" class="booking-card completed">
          <template is="booking-item" data="{{item}}"/>
        </view>
      </view>

      <!-- å·²å–æ¶ˆé¢„è®¢ -->
      <view wx:if="{{cancelledBookings.length > 0}}" class="section">
        <view class="section-title">
          <view class="title-icon">âŒ</view>
          <text class="title-text">å·²å–æ¶ˆ ({{cancelledBookings.length}})</text>
        </view>
        <view wx:for="{{cancelledBookings}}" wx:key="id" class="booking-card cancelled">
          <template is="booking-item" data="{{item}}"/>
        </view>
      </view>
    </view>
  </view>

  <!-- é¢„è®¢é¡¹ç›®æ¨¡æ¿ -->
  <template name="booking-item">
    <!-- æˆ¿å‹å›¾ç‰‡ -->
    <view class="room-image">
      <image src="{{item.roomImageUrl}}" 
             mode="aspectFill" 
             class="room-img"
             data-booking-id="{{item.id}}"
             data-room-type="{{item.roomType}}"
             lazy-load="{{true}}"
             show-menu-by-longpress="{{false}}"
             binderror="onImageError"/>
      <view class="status-tag {{item.statusClass}}">
        {{item.statusText}}
      </view>
    </view>

    <!-- é¢„è®¢ä¿¡æ¯ -->
    <view class="booking-content">
      <view class="booking-header">
        <view class="booking-id">è®¢å•å·: {{item.id}}</view>
        <view class="booking-amount">Â¥{{item.amount}}</view>
      </view>

      <view class="room-info">
        <view class="room-type">{{item.roomType}}</view>
        <view class="customer-name">{{item.customer}}</view>
      </view>

      <view class="date-info">
        <view class="date-row">
          <text class="date-label">å…¥ä½:</text>
          <text class="date-value">{{item.formattedStartDate}} 15:00</text>
        </view>
        <view class="date-row">
          <text class="date-label">ç¦»åº—:</text>
          <text class="date-value">{{item.formattedEndDate}} 12:00</text>
        </view>
      </view>

      <view wx:if="{{item.created_at}}" class="booking-time">
        é¢„è®¢æ—¶é—´: {{item.formattedCreatedAt}}
      </view>

      <!-- ç‰¹æ®ŠçŠ¶æ€ä¿¡æ¯ -->
      <view wx:if="{{item.status === 'cancelled' && item.rejection_reason}}" 
            class="rejection-info">
        <text class="rejection-label">å–æ¶ˆåŸå› :</text>
        <text class="rejection-text">{{item.rejection_reason}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="booking-actions">
        <button class="detail-btn" 
                data-booking="{{item}}" 
                bindtap="viewDetail">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        
        <!-- å–æ¶ˆé¢„è®¢æŒ‰é’® -->
        <button wx:if="{{item.status === 'pending' || item.status === 'confirmed'}}" 
                class="cancel-btn" 
                data-id="{{item.id}}"
                bindtap="cancelBooking">
          å–æ¶ˆé¢„è®¢
        </button>
        
        <!-- åˆ é™¤è®°å½•æŒ‰é’®ï¼ˆä»…é™å·²å®Œæˆæˆ–å·²å–æ¶ˆï¼‰ -->
        <button wx:if="{{item.canDelete}}" 
                class="delete-btn" 
                data-id="{{item.id}}"
                bindtap="deleteBooking">
          åˆ é™¤è®°å½•
        </button>
      </view>
    </view>
  </template>

  <!-- åº•éƒ¨æç¤º -->
  <view wx:if="{{isLoggedIn && (pendingBookings.length > 0 || confirmedBookings.length > 0 || completedBookings.length > 0 || cancelledBookings.length > 0)}}" class="footer-tip">
    <text>ä¸‹æ‹‰åˆ·æ–°è·å–æœ€æ–°çŠ¶æ€</text>
  </view>

</view>